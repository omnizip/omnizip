---
title: LZMA2
nav_order: 2
parent: Compression Algorithms
grand_parent: Guides
---

== Purpose

LZMA2 is an enhanced version of LZMA designed for better multi-threading support and improved handling of incompressible data. It's the default compression algorithm for modern 7-Zip archives.

== Key Characteristics

[cols="1,3"]
|===
|Property |Value

|Compression Ratio
|Excellent (same as LZMA)

|Compression Speed
|Slow to medium (with parallel speedup)

|Decompression Speed
|Fast

|Memory Usage
|Medium to high

|Multi-Threading
|Excellent support

|Best For
|Multi-core systems, modern archives, mixed content
|===

== LZMA2 vs LZMA

[cols="2,1,1,3"]
|===
|Feature |LZMA |LZMA2 |Advantage

|Compression Ratio
|Excellent
|Excellent
|Same quality

|Multi-Threading
|Limited
|Excellent
|LZMA2 is parallelizable

|Incompressible Data
|Poor
|Good
|LZMA2 handles better

|Chunk Independence
|No
|Yes
|LZMA2 can reset dictionary

|Default in 7-Zip
|No
|Yes
|LZMA2 is modern default

|Streaming
|Limited
|Better
|LZMA2 designed for streaming
|===

== When to Use LZMA2

**Choose LZMA2 when**:

* You have multi-core CPU and want parallel compression
* Working with mixed content (text + binary + compressed)
* Creating modern 7z archives (it's the default)
* Need better streaming support
* Want future-proof archives

**Use LZMA instead when**:

* Single-threaded environment
* Maintaining compatibility with old 7-Zip versions (<9.20)
* Slightly better compression ratio is critical

== Basic Usage

=== Create LZMA2 Archive

[source,ruby]
----
# Create with LZMA2 (modern default)
Omnizip::Archive.create('backup.7z', format: :seven_zip) do |archive|
  archive.compression = :lzma2  # Default for 7z
  archive.level = 9
  archive.add_directory('project/')
end
----

=== With Parallel Processing

Leverage multi-core CPUs:

[source,ruby]
----
# Use parallel processing with LZMA2
Omnizip::Archive.create('backup.7z', format: :seven_zip) do |archive|
  archive.compression = :lzma2
  archive.level = 7
  archive.parallel = true
  archive.threads = 4  # Use 4 cores
  archive.add_directory('large_project/')
end

# Can achieve 2-3x speedup on multi-core systems
----

== Compression Levels

Same levels as LZMA (1-9) but with better parallelization:

[cols="1,2,2,2"]
|===
|Level |Dictionary |Single-Thread |Multi-Thread (4 cores)

|5
|16 MB
|30s
|12s (2.5x faster)

|7
|32 MB
|60s
|22s (2.7x faster)

|9
|64 MB
|180s
|65s (2.8x faster)
|===

== Advanced Configuration

=== Chunk Size

Control parallelization granularity:

[source,ruby]
----
# Smaller chunks = better parallelization, more overhead
Omnizip::Archive.create('backup.7z', format: :seven_zip) do |archive|
  archive.compression = :lzma2
  archive.chunk_size = 8.megabytes  # Process 8 MB chunks
  archive.parallel = true
  archive.add_directory('data/')
end

# Larger chunks = less overhead, less parallel benefit
# Default: 64 MB (good balance)
----

=== Dictionary Reset

LZMA2 can reset dictionary for better incompressible data handling:

[source,ruby]
----
# Automatic dictionary reset for mixed content
Omnizip::Archive.create('mixed.7z', format: :seven_zip) do |archive|
  archive.compression = :lzma2
  archive.adaptive_dictionary = true  # Reset on incompressible blocks
  archive.add_directory('mixed_data/')  # Text + images + binaries
end
----

== Performance Characteristics

=== Parallel Speedup

[cols="2,1,1,1,1"]
|===
|File Mix |1 Thread |2 Threads |4 Threads |8 Threads

|All text
|60s
|35s
|20s
|15s

|Mixed content
|45s
|28s
|18s
|14s

|Many small files
|30s
|18s
|12s
|10s

|Few large files
|90s
|52s
|30s
|22s
|===

=== Incompressible Data Handling

LZMA2 handles incompressible data more efficiently:

[source]
----
File Type       LZMA Time    LZMA2 Time   Improvement
─────────────────────────────────────────────────────
JPEG images     45s          32s          ~30% faster
Mixed archive   60s          40s          ~33% faster
Video files     38s          25s          ~34% faster
Pure text       30s          30s          Same
----

== Use Cases

=== Multi-Core Server Backups

Maximize server CPU utilization:

[source,ruby]
----
# Server with 16 cores
Omnizip.compress_directory(
  '/var/www/',
  'www-backup.7z',
  compression: :lzma2,
  level: 9,
  parallel: true,
  threads: 16  # Use all cores
) do |progress|
  puts "#{progress.percentage}% - #{progress.active_threads} active threads"
end
----

=== Large Dataset Compression

Process large datasets efficiently:

[source,ruby]
----
# Compress large research dataset
Omnizip::Archive.create('dataset.7z', format: :seven_zip) do |archive|
  archive.compression = :lzma2
  archive.level = 9
  archive.solid = true  # Better compression
  archive.parallel = true

  # Add gigabytes of data
  archive.add_directory('research_data/')
end
----

=== Software Build Artifacts

Package build outputs with parallel compression:

[source,ruby]
----
# Package release after build
Omnizip.compress_directory(
  'build/release/',
  "app-#{version}.7z",
  compression: :lzma2,
  level: 7,
  filter: :bcj_x86,  # For executables
  parallel: true
)
----

== Command-Line Usage

[source,bash]
----
# Create LZMA2 archive
$ omnizip archive create backup.7z files/ \
    --compression lzma2 \
    --level 9

# With parallel processing
$ omnizip archive create backup.7z files/ \
    --compression lzma2 \
    --level 9 \
    --parallel \
    --threads 8

# Show compression statistics
$ omnizip archive create backup.7z files/ \
    --compression lzma2 \
    --level 9 \
    --stats
Algorithm: LZMA2, Level: 9
Dictionary: 64 MB
Threads: 8
Original: 1.2 GB
Compressed: 456 MB (62% reduction)
Time: 3m 45s (2.7x speedup from parallelization)
----

== Technical Details

**LZMA2 Improvements over LZMA**:

. **Chunk-Based**: Data divided into independent chunks for parallel processing
. **Dictionary Reset**: Can reset dictionary between chunks
. **Uncompressed Chunks**: Stores incompressible data without overhead
. **Better Streaming**: Designed for better streaming support
. **Error Recovery**: Better error isolation (chunk-level vs. stream-level)

== See Also

* link:lzma.html[LZMA] - Original algorithm
* link:zstandard.html[Zstandard] - Fast alternative
* link:../advanced-features/parallel-processing.html[Parallel Processing] - Maximize LZMA2 performance
* link:../../compatibility.html[Compatibility] - LZMA2 support across tools